/*
 * fsm_auto.c
 *
 *  Created on: Nov 4, 2022
 *      Author: Admin
 */

#include "fsm_auto.h"

enum state mode = INIT;

int counter = COUNTER;

void fsm_simple_buttons_run (){
	if(timer1_flag == 1){
		TOGGLE();
		setTimer1(ONE_SEC);
	}

	switch(mode){
	case INIT:
		mode = NORM_STATE;
		setTimer1(REV_TIMER_UP); //LED
		setTimer2(REV_TIMER_UP); //SEG7
		setTimer3(REV_TIMER_UP); //Long pressed but do nothing
		setTimer4(REV_TIMER_UP);
		break;

	case NORM_STATE:
		if(isButtonPressed(RES_BUTTON)){
			mode = RES_STATE;
			counter = END_COUNT;
			setTimer3(TEN_SEC);
			display7SEG1(counter);
		}

		if(isButtonPressed(INC_BUTTON)){
			mode = INC_STATE;
			counter++;
			setTimer3(TEN_SEC);
			display7SEG1(counter);
		}

		if(isButtonPressed(DEC_BUTTON)){
			mode = DEC_STATE;
			counter--;
			setTimer3(TEN_SEC);
			display7SEG1(counter);
		}

		if(timer2_flag == 1){
			display7SEG1(counter);
			if(counter > 0) counter--;
			setTimer2(100);
		}
		break;
	case RES_STATE:
		if(isButtonPressed(RES_BUTTON)){
			counter = 0;
			setTimer3(500);
			display7SEG1(counter);
		}

		if(timer3_flag == 1){
			mode = NORMAL_STATE;
			setTimer3(500);
		}
		break;
	case INC_STATE:
		if(isButtonPressed(INC_BUTTON)){
			counter++;
			if(counter > 9) counter = 0;
			setTimer3(500);
			display7SEG1(counter);
		}

		if(isLongButtonPressed(INC_BUTTON)){
			setTimer4(100);
		}

		if(timer3_flag == 1){
			mode = NORMAL_STATE;
			setTimer3(500);
		}

		if(timer4_flag == 1){
			counter++;
			if(counter > 9) counter = 0;
			display7SEG1(counter);
			setTimer4(100);
		}
		break;
	case DEC_STATE:
		if(isButtonPressed(DEC_BUTTON)){
			counter--;
			if(counter < 0) counter = 9;
			setTimer3(500);
			display7SEG1(counter);
		}

		if(isLongButtonPressed(DEC_BUTTON)){
			setTimer4(100);
		}

		if(timer3_flag == 1){
			mode = NORMAL_STATE;
			setTimer3(500);
		}

		if(timer4_flag == 1){
			counter--;
			if(counter > 9) counter = 0;
			display7SEG1(counter);
			setTimer4(100);
		}
		break;
	}
}
